---
title: "Rebalance crank"
description: "When an operator submits tx deposit\_strategy or withdraw_strategy, we call this the rebalance crank."
---

<Frame>
  <img src="/images/dynamic-vault-integration/dynamic-vaults/hermes-meteoras-keeper/image-1.png" />
</Frame>

We call state variables before the rebalance:

* vault.total\_amount : t1

* token\_vault.amount : a1

* strategy.current\_liquidity : c1

And the state variables after the rebalance:

* vault.total\_amount : t2

* token\_vault.amount : a2

* strategy.current\_liquidity : c2

Then the vault would know that the total accrued interest after rebalance is:

$$
\text{profit} = (c_2 + a_2) - (c_1 + a_1)
$$

Then vault can update the total amount:

$$
t_2 = t_1 + \text{profit}
$$

Or:

$$
t_2 = t_1 + (c_2 + a_2) - (c_1 + a_1)
$$

The immediate release of profit generated to the LPs can result in opportunities for a sandwich attack as seen in the scenario below:

<Frame>
  <img src="/images/dynamic-vault-integration/dynamic-vaults/hermes-meteoras-keeper/image-2.png" />
</Frame>

An attacker is able to time their deposit before a rebalance and withdraw immediately after a rebalance in order to get the max profit. In the example above, the attacker is able to earn 10 tokens as a reward by executing the sandwich attack.

### Sandwich Attack Prevention

Instead of distributing 100% of the yield generated by the lending platforms to the LPs immediately after rebalancing, the system will drip the yield to the LPs across a pre-determined period of time.

We need to define the following state variables Total\_amount: The total amount of liquidity collected (balance in vault + balances in all strategies) Last\_updated\_locked\_profit: Total locked profit, updated every time we do rebalancing Last\_report: timestamp of the last rebalancing run Locked\_profit\_degradation: Rate at which the profit will be unlocked in % per second e.g. 0.1% of locked\_profits released per second.

When a user adds or removes liquidity, instead of using vault.total\_amount to calculate the total lp to mint or burn, we use the get\_unlock\_amount function to calculate the unlocked\_amount value to use.

$$
\text{duration} = \text{currentTime} - \text{lastReport}
$$

$$
\text{lockedFundRatio} = 1 - \text{duration} \times \text{lockedProfitDegradation}
$$

$$
\text{unlockedAmount} = \text{totalAmount} - \text{lastUpdatedLockedProfit} \times \text{lockedFundRatio}
$$

Example: Drip duration: 5 mins

<Frame>
  <img src="/images/dynamic-vault-integration/dynamic-vaults/hermes-meteoras-keeper/image-3.png" />
</Frame>

As seen in the example above, the rebalancing at t = 2 mins will gain a total of 100 token as yield from the lending platforms. However, as we are using the unlocked amount value to calculate the withdrawal amount, the attacker will not get any of the yield gained if he were to withdraw his tokens immediately after rebalancing. He will also only gain a fraction of the total yield if he withdraws within the next few minutes.
